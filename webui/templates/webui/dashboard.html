{% extends 'common/base.html' %}
{% load i18n staticfiles %}

{% block title %}{% trans 'Dashboard' %}{% endblock %}

{% block javascripts %}        <script src="//api-maps.yandex.ru/2.0-stable/?load=package.full&lang=ru-RU"></script>
        <!-- <script src="{% static 'js/ymaps.js' %}"></script> -->
        <script>
            var dashboard_map;
            ymaps.ready(function(){
                dashboard_map = new ymaps.Map("dashboard-map", {
                    center: [55.76, 37.64],
                    zoom: 10
                });
            
                dashboard_map.controls
                    .add('zoomControl', { left: 5, top: 5 })
                    .add('typeSelector')
                    .add('mapTools', { left: 35, top: 5 });
                
                $.getJSON('/api/units.json')
                    .done(function(data){
                        $.each(data, function(element, object) {
                            $.getJSON('/api/units/'+object.imei+'.json')
                                .done(function(data){
                                    dashboard_map.geoObjects.add(new ymaps.Placemark(
                                            [data.latitude, data.longitude],
                                            {
                                                balloonContentHeader: data.name,
                                                balloonContentBody: data.timestamp
                                            }
                                    ));
                                })
                                .fail(function(jqxhr, textStatus, error){
                                    alert('fail: '+jqxhr+textStatus+error);
                                });
                        });
                    })
                    .fail(function(jqxhr, textStatus, error){
                        alert('fail: '+jqxhr+textStatus+error);
                    });
                });
        </script>
{% endblock %}

{% block content %}
            <div class="dashboard">
                <div class="quick-add-unit">
                    <form action="/units/add.html?next=/dashboard.html" method="post">
                        {% csrf_token %}
                        <input type="text" name="name" id="inputName" placeholder="Name" />
                        <input type="text" name="imei" id="inputIMEI" placeholder="IMEI" />
                        <button type="submit" class="btn">{% trans 'Add' %}</button>
                    </form>
                </div>
                <div class="units-list">
                    <table class="table table-striped">
                        <tr>
                            <td>{% trans '#' %}</td>
                            <td>{% trans 'Unit name' %}</td>
                            <td>{% trans 'Unit IMEI' %}</td>
                            <td>{% trans 'Unit last location' %}</td>
                            <td>{% trans 'Last seen' %}</td>
                            <td>{% trans 'Actions' %}</td>
                        </tr>
                        {% for unit in units %}
                        <tr>
                            <td>{{ forloop.counter }}</td>
                            <td><a href="/units/{{ unit.imei }}.html">{{ unit.name }}</a></td>
                            <td>{{ unit.imei }}</td>
                            <td>{{ unit.get_lastlocation.position }}</td>
                            <td>{{ unit.get_lastseen|timesince }} {% trans 'ago' %}</td>
                            <td><a class="btn" href="/units/delete/{{ unit.imei }}.html">Delete</a></td>
                        </tr>
                        {% endfor %}
                        <tr>
                            <td colspan="6"><a href="/units.html">...</a></td>
                        </tr>
                    </table>
                </div>
                <div class="last-location">
                    <div id="dashboard-map" class="dashboard-map span11"></div>
                </div>
            </div>
{% endblock %}